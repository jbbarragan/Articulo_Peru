<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mapa de Cuerpos de Agua - Perú</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  height: 100vh;
  overflow: hidden;
}

#map {
  height: 100vh;
  width: 100%;
}

.info-panel {
  position: absolute;
  top: 10px;
  right: 10px;
  background: white;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,.3);
  z-index: 1000;
  max-width: 320px;
  max-height: 90vh;
  overflow-y: auto;
}

.info-panel h3 {
  margin-bottom: 10px;
  color: #333;
}

.filter-section {
  margin: 10px 0;
}

.filter-section label {
  display: flex;
  align-items: center;
  margin: 5px 0;
  cursor: pointer;
}

.filter-section input[type="checkbox"] {
  margin-right: 8px;
}

.filter-section input[type="radio"] {
  margin-right: 8px;
}

.color-indicator {
  display: inline-block;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  margin-right: 5px;
  border: 1px solid #333;
}

.filter-toggle {
  position: absolute;
  top: 10px;
  left: 10px;
  background: white;
  padding: 12px 15px;
  border-radius: 6px;
  cursor: pointer;
  z-index: 1000;
  box-shadow: 0 2px 5px rgba(0,0,0,.2);
  font-size: 18px;
  font-weight: bold;
}

.filter-toggle:hover {
  background: #f0f0f0;
}

.loading {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 20px 30px;
  border-radius: 8px;
  z-index: 2000;
  font-weight: bold;
  box-shadow: 0 4px 15px rgba(0,0,0,.3);
}

.legend {
  margin-top: 15px;
  padding-top: 15px;
  border-top: 2px solid #ddd;
}

.legend-item {
  display: flex;
  align-items: center;
  margin: 5px 0;
  font-size: 13px;
}

hr {
  margin: 15px 0;
  border: none;
  border-top: 1px solid #ddd;
}

#stats {
  font-size: 13px;
  line-height: 1.6;
}

.leaflet-popup-content {
  margin: 10px;
  line-height: 1.6;
}

.leaflet-popup-content b {
  color: #2c5aa0;
  font-size: 14px;
}

.map-type-section {
  margin: 10px 0;
  padding: 10px;
  background: #f8f8f8;
  border-radius: 5px;
}
</style>
</head>

<body>

<div id="map"></div>
<div class="loading" id="loading">Cargando datos del mapa...</div>

<div class="filter-toggle" onclick="togglePanel()">☰</div>

<div class="info-panel" id="infoPanel">
  
  <div class="map-type-section">
    <b>Tipo de Mapa</b><br>
    <label><input type="radio" name="mapType" value="street" checked onchange="changeMapType('street')"> Calles</label>
    <label><input type="radio" name="mapType" value="satellite" onchange="changeMapType('satellite')"> Satélite</label>
    <label><input type="radio" name="mapType" value="topographic" onchange="changeMapType('topographic')"> Topográfico</label>
  </div>

  <div class="legend">
    <div class="legend-item">
      <span class="color-indicator" style="background: #1E90FF;"></span>
      Azul: Sin contaminación, sin minas
    </div>
    <div class="legend-item">
      <span class="color-indicator" style="background: #FF8C00;"></span>
      Naranja: Sin contaminación, con minas
    </div>
    <div class="legend-item">
      <span class="color-indicator" style="background: #8B4513;"></span>
      Café: Contaminado (nivel 1)
    </div>
    <div class="legend-item">
      <span class="color-indicator" style="background: #000000;"></span>
      Negro: Muy contaminado (nivel 2)
    </div>
    <div class="legend-item">
      <span class="color-indicator" style="background: #FF1493;"></span>
      Rosa: Contaminado + minas cercanas
    </div>
  </div>

  <hr>
  
  <div class="filter-section">
    <b>Filtrar</b><br>
    <label><input type="checkbox" checked onchange="toggleContamination(0)"> Sin contaminación</label>
    <label><input type="checkbox" checked onchange="toggleContamination(1)"> Contaminado</label>
    <label><input type="checkbox" checked onchange="toggleContamination(2)"> Muy contaminado</label>
  </div>

  <div class="filter-section">
    <label><input type="checkbox" checked onchange="toggleMines(false)"> Sin minas cercanas</label>
    <label><input type="checkbox" checked onchange="toggleMines(true)"> Con minas cercanas</label>
  </div>

  <hr>
  <div id="stats"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<script>
// Variables globales
let map;
let allMarkers = [];
let contaminationFilters = {0: true, 1: true, 2: true};
let mineFilters = {true: true, false: true};
let currentLayer;

const statsDiv = document.getElementById("stats");
const loadingDiv = document.getElementById("loading");
const infoPanel = document.getElementById("infoPanel");

// Definir las capas de mapa
const mapLayers = {
  street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors',
    maxZoom: 19
  }),
  satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles © Esri',
    maxZoom: 19
  }),
  topographic: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
    attribution: 'Map data: © OpenStreetMap contributors, SRTM | Map style: © OpenTopoMap',
    maxZoom: 17
  })
};

// Inicializar mapa
initMap();

function initMap() {
  // Centrar en Perú
  map = L.map('map').setView([-9.19, -75.015], 6);

  // Capa de mapa base (por defecto: calles)
  currentLayer = mapLayers.street;
  currentLayer.addTo(map);

  // Cargar datos
  loadCSV();
}

function changeMapType(type) {
  // Remover la capa actual
  if (currentLayer) {
    map.removeLayer(currentLayer);
  }
  
  // Agregar la nueva capa
  currentLayer = mapLayers[type];
  currentLayer.addTo(map);
}

function loadCSV() {
  // Intentar cargar el archivo desde la ubicación correcta
  const csvPath = 'data.csv';
  
  Papa.parse(csvPath, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      console.log("Datos cargados:", results.data.length, "registros");
      console.log("Campos:", results.meta.fields);
      processData(results.data);
      loadingDiv.style.display = 'none';
    },
    error: function(error) {
      console.error("Error al cargar CSV:", error);
      loadingDiv.innerHTML = "Error: No se pudo cargar el archivo data.csv";
    }
  });
}

function getMarkerColor(contamination, hasMines) {
  // Lógica de colores según especificaciones:
  // - Azul (#1E90FF): Sin contaminación, sin minas
  // - Naranja (#FF8C00): Sin contaminación, con minas
  // - Café (#8B4513): Contaminado (nivel 1), sin minas
  // - Negro (#000000): Muy contaminado (nivel 2), sin minas
  // - Rosa (#FF1493): Cualquier contaminación + minas
  
  if (contamination > 0 && hasMines) {
    return '#FF1493'; // Rosa: contaminado + minas
  }
  
  if (contamination === 2) {
    return '#000000'; // Negro: muy contaminado
  }
  
  if (contamination === 1) {
    return '#8B4513'; // Café: contaminado
  }
  
  if (hasMines) {
    return '#FF8C00'; // Naranja: minas cercanas sin contaminación
  }
  
  return '#1E90FF'; // Azul: sin problemas
}

function processData(data) {
  let stats = {
    total: 0,
    withMines: 0,
    noContamination: 0,
    contaminated: 0,
    veryContaminated: 0
  };

  data.forEach((row, index) => {
    // Extraer latitud y longitud
    let lat = parseFloat(row.lat);
    let lon = parseFloat(row.lon);

    // Validar coordenadas
    if (isNaN(lat) || isNaN(lon)) {
      return;
    }

    // Extraer datos
    let region = row.Region || '';
    let nombre = row.Nombre || 'Sin nombre';
    let tipo = row.Tipo || '';
    let densidadPoblacional = row['Densidad poblacional'] || '';
    let tipoSuelo = row['Tipo de suelo'] || '';
    let usoSuelo = row['uso de suelo'] || '';
    
    // Determinar si tiene minas cerca
    let minasCercaValue = row['Minas Cerca?'] || '';
    let hasMines = minasCercaValue.toString().trim() === '1';
    
    // Contar cantidad de minas (columna "Cantidad")
    let cantidadMinas = row.Cantidad || '';
    
    // Determinar nivel de contaminación
    let contaminacionValue = row['Contaminación'] || '';
    let contamination = 0;
    if (contaminacionValue.toString().trim() === '1') {
      contamination = 1;
    } else if (contaminacionValue.toString().trim() === '2') {
      contamination = 2;
    }
    
    // Tipo de contaminación
    let tipoContaminacion = row['Tipo de contaminación'] || '';

    // Actualizar estadísticas
    stats.total++;
    if (hasMines) stats.withMines++;
    if (contamination === 0) stats.noContamination++;
    if (contamination === 1) stats.contaminated++;
    if (contamination === 2) stats.veryContaminated++;

    // Determinar color del marcador
    let markerColor = getMarkerColor(contamination, hasMines);

    // Crear popup con información
    let popupContent = `
      <b>${nombre}</b><br>
      <b>Región:</b> ${region}<br>
      <b>Lat:</b> ${lat.toFixed(6)}<br>
      <b>Lon:</b> ${lon.toFixed(6)}<br>
      <b>Tipo:</b> ${tipo}<br>
      <b>Densidad poblacional:</b> ${densidadPoblacional}<br>
      <b>Tipo de suelo:</b> ${tipoSuelo}<br>
      <b>Uso de suelo:</b> ${usoSuelo}
    `;

    // Agregar información de minas si corresponde
    if (hasMines) {
      popupContent += `<br><b>Cantidad de minas cercanas:</b> ${cantidadMinas || 'No especificado'}`;
    }

    // Agregar información de contaminación si corresponde
    if (contamination > 0) {
      popupContent += `<br><b>Tipo de Contaminación:</b> ${tipoContaminacion || 'No especificado'}`;
    }

    // Crear marcador
    let marker = L.circleMarker([lat, lon], {
      radius: 6,
      fillColor: markerColor,
      color: '#FFFFFF',
      weight: 1.5,
      fillOpacity: 0.8
    }).bindPopup(popupContent);

    // Guardar propiedades para filtros
    marker.contamination = contamination;
    marker.hasMines = hasMines;

    // Agregar al mapa
    marker.addTo(map);
    allMarkers.push(marker);
  });

  // Mostrar estadísticas
  updateStats(stats);
}

function updateStats(stats) {
  statsDiv.innerHTML = `
    <b>Estadísticas Generales</b><br>
    Total de cuerpos: ${stats.total}<br>
    Con minas cercanas: ${stats.withMines}<br>
    <br>
    <b>Por contaminación:</b><br>
    Sin contaminación: ${stats.noContamination}<br>
    Contaminados: ${stats.contaminated}<br>
    Muy contaminados: ${stats.veryContaminated}
  `;
}

function toggleContamination(level) {
  contaminationFilters[level] = !contaminationFilters[level];
  applyFilters();
}

function toggleMines(hasMines) {
  mineFilters[hasMines] = !mineFilters[hasMines];
  applyFilters();
}

function applyFilters() {
  allMarkers.forEach(marker => {
    let show = true;

    // Filtrar por contaminación
    if (!contaminationFilters[marker.contamination]) {
      show = false;
    }

    // Filtrar por minas
    if (!mineFilters[marker.hasMines]) {
      show = false;
    }

    // Mostrar u ocultar marcador
    if (show) {
      if (!map.hasLayer(marker)) {
        marker.addTo(map);
      }
    } else {
      map.removeLayer(marker);
    }
  });
}

function togglePanel() {
  if (infoPanel.style.display === 'none') {
    infoPanel.style.display = 'block';
  } else {
    infoPanel.style.display = 'none';
  }
}
</script>

</body>
</html>